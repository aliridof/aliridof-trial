
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inspect Element</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg: #ffffff;
  --bg-secondary: #f9fafb;
  --border: #e5e7eb;
  --text: #111827;
  --text-secondary: #6b7280;
  --accent: #2563eb;
  --accent-text: #ffffff;
  --hover: #f3f4f6;
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  --font-mono: 'Roboto Mono', 'SF Mono', 'Fira Code', 'Fira Mono', monospace;
  --radius: 6px;
  --header-height: 52px;
}
[data-theme="dark"]{
  --bg: #0f172a;
  --bg-secondary: #1e293b;
  --border: #334155;
  --text: #f8fafc;
  --text-secondary: #94a3b8;
  --accent: #3b82f6;
  --accent-text: #ffffff;
  --hover: #334155;
}
body{
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  font-size: 14px;
}
.app{display:flex;height:100vh}
.header{
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: var(--header-height);
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
}
.tabs{display:flex;gap:4px}
.tab{
  padding: 8px 16px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all .15s ease-in-out;
}
.tab:hover{
  background: var(--hover);
  color: var(--text);
}
.tab.active{
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.controls{display:flex;gap:8px;align-items:center;position: relative;}
.btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--accent);
  color: var(--accent-text);
  border: 1px solid var(--accent);
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all .15s ease-in-out;
}
.btn:hover{opacity:.85}
.btn.outline{
  background: transparent;
  color: var(--text);
  border-color: var(--border);
}
.btn.outline:hover{background:var(--hover)}
.control-btn{
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  border-radius: var(--radius);
  transition: all .15s;
}
.control-btn:hover{background:var(--hover);color:var(--text)}
.control-btn.active {
  background: var(--accent);
  color: var(--accent-text);
}
.control-btn.active:hover {
  opacity: .85;
}
.separator {
  width: 1px;
  height: 24px;
  background: var(--border);
}
.left{
  width: 40%;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  margin-top: var(--header-height);
}
.right{
  flex: 1;
  display: flex;
  flex-direction: column;
  margin-top: var(--header-height);
}
.chat{display:flex;flex-direction:column;height:100%}
.messages{flex:1;overflow-y:auto;padding:16px}
.msg{
  margin-bottom: 12px;
  padding: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-size: 14px;
  line-height: 1.5;
  position: relative;
}
.msg-actions{
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 4px;
}
.msg-actions button{
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 50%;
  transition: all .15s ease-in-out;
}
.msg-actions button:hover{background:var(--hover); color: var(--text)}
.msg pre{
  margin-top: 8px;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-family: var(--font-mono);
  font-size: 13px;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.msg.editing textarea{
  width: 100%;
  margin-top: 8px;
}
.input-area{
  border-top: 1px solid var(--border);
  padding: 12px;
  display: flex;
  gap: 8px;
  background: var(--bg);
}
textarea{
  flex: 1;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 14px;
  resize: none;
}
textarea:focus{outline:2px solid var(--accent);border-color:transparent}
.input-btns{display:flex;gap:8px;flex-direction:column}
.input-btns button{padding:8px;width:38px;height:38px;justify-content:center}
.content{flex:1;position:relative;overflow:hidden}
.view{display:none;height:100%}
.view.active{display:flex;flex-direction:column}

/* --- Start Code View --- */
.code-view {
  display: flex;
  height: 100%;
}
.file-explorer {
  width: 240px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  user-select: none;
  position: relative;
}
.file-explorer-header {
  padding: 8px 8px 8px 16px;
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  color: var(--text-secondary);
  letter-spacing: 0.5px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.file-explorer-actions {
  display: flex;
  align-items: center;
  gap: 4px;
}
.file-explorer-actions .control-btn {
  width: 28px;
  height: 28px;
}
.dropdown-menu {
  display: none;
  position: absolute;
  top: 44px;
  right: 8px;
  z-index: 20;
  background-color: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  padding: 4px;
  width: 200px;
}
[data-theme="dark"] .dropdown-menu {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.dropdown-menu.active {
    display: block;
}
.dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 8px;
    border: none;
    background: transparent;
    color: var(--text);
    text-align: left;
    font-size: 13px;
    cursor: pointer;
    border-radius: 4px;
    font-family: var(--font-sans);
    font-weight: 500;
}
.dropdown-item:hover {
    background: var(--hover);
}
.dropdown-item.active {
  background: var(--accent);
  color: var(--accent-text);
}
.dropdown-item.active svg {
    color: var(--accent-text);
}
.dropdown-item svg {
    color: var(--text-secondary);
    width: 16px;
    height: 16px;
    flex-shrink: 0;
}
.file-list {
  padding: 0 8px;
  overflow-y: auto;
  flex-grow: 1;
}
.file-item {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
}
.file-item:hover {
  background: var(--hover);
}
.file-item.active {
  background: var(--accent);
  color: var(--accent-text);
}
.file-item.active .file-icon {
  color: var(--accent-text);
}
.file-item-actions {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  opacity: 0;
  transition: opacity .15s ease-in-out;
  border-radius: var(--radius);
}
.file-item:hover .file-item-actions, .file-item.context-menu-open .file-item-actions {
  opacity: 1;
}
.file-item-actions .control-btn {
  width: 26px;
  height: 26px;
  padding: 0;
}
.file-item .file-name {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 30px;
}
#fileContextMenu {
    position: fixed;
    z-index: 30;
    width: 200px;
}
.file-icon {
  color: var(--text-secondary);
  flex-shrink: 0;
  width: 16px;
  height: 16px;
}
.editor-pane {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg);
}
.editor-tabs {
  display: flex;
  background: var(--bg);
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}
.editor-tab {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 12px;
  font-size: 13px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  user-select: none;
  cursor: pointer;
  white-space: nowrap;
}
.editor-tab.active {
    background: var(--bg);
    color: var(--accent);
}
.editor-tab.active .file-icon {
    color: var(--accent);
}
.editor-tab:not(.active):hover {
    background: var(--hover);
}
.close-tab-btn {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 4px;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 12px;
  font-size: 16px;
  line-height: 1;
}
.close-tab-btn:hover {
  background: var(--hover);
  color: var(--text);
}
.editor-tab.active .close-tab-btn:hover {
    background: var(--accent);
    color: var(--accent-text);
    opacity: 0.7;
}
.code-editor {
  flex: 1;
  display: flex;
  overflow: auto;
  position: relative;
  background: var(--bg);
  font-family: var(--font-mono);
  font-size: 13px;
}
.line-numbers {
  padding: 12px 8px 12px 12px;
  line-height: 1.6;
  color: var(--text-secondary);
  background: var(--bg);
  text-align: right;
  user-select: none;
  white-space: pre;
}
#codeArea{
  flex: 1;
  width: 100%;
  padding: 12px;
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.6;
  border: none;
  background: transparent;
  color: var(--text);
  border-radius: 0;
  resize: none;
  outline: none;
  white-space: pre;
  word-wrap: normal;
  overflow-y: hidden;
}
.code-actions{
  display:flex;
  gap:8px;
  padding: 12px;
  background: var(--bg);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
/* --- End Code View --- */

/* --- Start API View --- */
#apiView {
    padding: 24px;
    overflow-y: auto;
    background: var(--bg-secondary);
}
.api-container {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 32px;
}
.api-header h2 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 4px;
}
.api-header p {
    color: var(--text-secondary);
}
.api-form-container, .api-list-container {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
}
.api-form-container h3, .api-list-container h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}
.api-form {
    display: flex;
    gap: 12px;
    align-items: center;
}
.api-form input {
    flex: 1;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-size: 13px;
    font-family: var(--font-sans);
}
.api-form input:focus {
    outline: 2px solid var(--accent);
    border-color: transparent;
}
.api-list .empty-state {
    text-align: center;
    padding: 32px;
    color: var(--text-secondary);
    font-style: italic;
}
.api-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}
.api-item:last-child {
    border-bottom: none;
}
.api-item-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.api-item-name {
    font-weight: 500;
}
.api-item-key {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-secondary);
    cursor: default;
}
.api-item-actions {
    display: flex;
    gap: 8px;
}
/* --- End API View --- */


.url-bar{
  padding: 12px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 8px;
}
.url-bar input{
  flex: 1;
  padding: 8px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 13px;
}
.url-bar input:focus{outline:2px solid var(--accent);border-color:transparent}
.preview-wrap{flex:1;position:relative;background:var(--bg)}
.preview-frame{width:100%;height:100%;border:none;background:#fff}
.overlay{
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  display: none;
  cursor: crosshair;
}
.overlay.active{display:block}
.badge{
  position: absolute;
  bottom: 16px;
  right: 16px;
  padding: 6px 12px;
  background: var(--accent);
  color: var(--accent-text);
  font-size: 12px;
  font-weight: 500;
  border-radius: var(--radius);
  display: none;
}
.badge.active{display:block}
/* --- Start Device Preview --- */
.preview-wrap.device-mode {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  padding: 32px;
  overflow: auto;
}
.preview-wrap.device-mode .preview-frame {
  flex-shrink: 0;
  box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
  border: 1px solid var(--border);
  transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
}
[data-theme="dark"] .preview-wrap.device-mode .preview-frame {
  box-shadow: 0 10px 30px -5px rgba(0,0,0,0.3);
}
#deviceMenu {
  right: auto;
  left: 50%;
  transform: translateX(-50%);
  width: 160px;
}
/* --- End Device Preview --- */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bg-secondary)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--text-secondary)}
@media(max-width:768px){
  .app{flex-direction:column}
  .left{width:100%;height:50%;border-right:none;border-bottom:1px solid var(--border)}
  .right{height:50%}
}
</style>
</head>
<body data-theme="light">

<div class="header">
  <div class="tabs">
    <button class="tab" data-view="log">Log</button>
    <button class="tab active" data-view="preview">Preview</button>
    <button class="tab" data-view="code">Code</button>
    <button class="tab" data-view="url">URL</button>
    <button class="tab" data-view="api">API</button>
  </div>
  <div class="controls">
    <button class="control-btn" id="fullscreenBtn" title="Full screen" aria-label="Full screen">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
    </button>
    <button class="control-btn" id="deviceBtn" title="Device" aria-label="Device">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect><path d="M12 18h.01"></path><path d="M19 4h1a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-1"></path><path d="M5 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h1"></path></svg>
    </button>
    <div class="dropdown-menu" id="deviceMenu">
        <button class="dropdown-item active" data-device="desktop">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
            <span>Desktop</span>
        </button>
        <button class="dropdown-item" data-device="tablet">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
            <span>Tablet</span>
        </button>
        <button class="dropdown-item" data-device="mobile">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
            <span>Mobile</span>
        </button>
    </div>
    <button class="control-btn" id="reloadBtn" title="Reload" aria-label="Reload">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
    </button>
    <div class="separator"></div>
    <button class="control-btn" id="inspectBtn" title="Inspect (Ctrl+Shift+C)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
    </button>
    <button class="control-btn" id="themeBtn" aria-label="Toggle theme">
      <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>
  </div>
</div>

<div class="app">
  <div class="left">
    <div class="chat">
      <div class="messages" id="chatMessages"></div>
      <div class="input-area">
        <textarea id="chatInput" placeholder="Type your notes... (Ctrl+Enter to send)"></textarea>
        <div class="input-btns">
          <button class="btn" id="sendBtn" title="Send (Ctrl+Enter)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
          <button class="btn outline" id="clearBtn" title="Delete all messages">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
          <button class="btn outline" id="exportBtn" title="Export Chat">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="content">
      <div class="view" id="logView">
        <div class="preview-wrap" style="background:var(--bg);padding:16px;overflow-y:auto">
          <h3 style="margin-bottom:16px; font-weight: 500;">System Logs</h3>
          <div id="logMessages"></div>
        </div>
      </div>

      <div class="view active" id="previewView">
        <div class="preview-wrap">
          <iframe id="previewFrame" class="preview-frame"></iframe>
          <div class="overlay" id="previewOverlay"></div>
          <div class="badge" id="previewBadge">INSPECTING</div>
        </div>
      </div>

      <div class="view" id="codeView">
        <div class="code-view">
          <aside class="file-explorer">
            <div class="file-explorer-header">
              <span>File explorer</span>
              <div class="file-explorer-actions">
                <button class="control-btn" title="Search">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
                <button class="control-btn" id="addFileMenuBtn" title="New...">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                <button class="control-btn" title="Collapse">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
              </div>
            </div>
            <div class="dropdown-menu" id="addFileMenu">
                <button class="dropdown-item" onclick="appUploadFiles()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Upload files</span>
                </button>
                <button class="dropdown-item" onclick="appUploadFolder()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><path d="M12 10v6"></path><path d="m15 13-3-3-3 3"></path></svg>
                    <span>Upload folder</span>
                </button>
                <button class="dropdown-item" onclick="appCreateFile()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    <span>Create new file</span>
                </button>
                <button class="dropdown-item" onclick="appCreateFolder()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path><line x1="12" y1="10" x2="12" y2="16"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>
                    <span>Create new folder</span>
                </button>
            </div>
            <nav class="file-list"><!-- Content generated by JS --></nav>
            <div class="dropdown-menu" id="fileContextMenu">
                <button class="dropdown-item" data-action="editor">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span>Show in editor</span>
                </button>
                <button class="dropdown-item" data-action="rename">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    <span>Rename</span>
                </button>
                <button class="dropdown-item" data-action="move">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>
                    <span>Move</span>
                </button>
                <button class="dropdown-item" data-action="delete">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    <span>Delete</span>
                </button>
            </div>
          </aside>
          <main class="editor-pane">
            <div class="editor-tabs"><!-- Tabs generated by JS --></div>
            <div class="code-editor">
              <pre class="line-numbers" id="lineNumbers">1</pre>
              <textarea id="codeArea" placeholder="Select a file to start editing..." spellcheck="false"></textarea>
            </div>
            <div class="code-actions">
              <button class="btn" id="renderBtn">Render</button>
              <button class="btn outline" id="clearCodeBtn">Clear</button>
            </div>
          </main>
        </div>
      </div>


      <div class="view" id="urlView">
        <div class="url-bar">
          <input type="url" id="urlInput" placeholder="https://example.com">
          <button class="btn" id="goBtn">Go</button>
        </div>
        <div class="preview-wrap">
          <iframe id="urlFrame" class="preview-frame"></iframe>
          <div class="overlay" id="urlOverlay"></div>
          <div class="badge" id="urlBadge">INSPECTING</div>
        </div>
      </div>
      
      <div class="view" id="apiView">
        <div class="api-container">
            <div class="api-header">
                <h2>API Key Management</h2>
                <p>Securely store and manage your API keys for various services.</p>
            </div>
            <div class="api-form-container">
                <h3>Add New API Key</h3>
                <form id="addApiKeyForm" class="api-form">
                    <input type="text" id="apiNameInput" placeholder="Service Name (e.g., Google Gemini)" required>
                    <input type="password" id="apiKeyValueInput" placeholder="API Key" required>
                    <button type="submit" class="btn">Add Key</button>
                </form>
            </div>
            <div class="api-list-container">
                <h3>Saved Keys</h3>
                <div id="apiList" class="api-list">
                    <!-- API keys will be rendered here by apiManager -->
                </div>
            </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const state = {
    view: 'preview',
    device: 'desktop',
    inspect: false,
    frame: null,
    overlay: null,
    badge: null,
    logs: []
  };

  const el = {
    views: document.querySelectorAll('.view'),
    tabs: document.querySelectorAll('.tab'),
    chatMessages: document.getElementById('chatMessages'),
    logMessages: document.getElementById('logMessages'),
    chatInput: document.getElementById('chatInput'),
    previewFrame: document.getElementById('previewFrame'),
    urlFrame: document.getElementById('urlFrame'),
    previewOverlay: document.getElementById('previewOverlay'),
    urlOverlay: document.getElementById('urlOverlay'),
    previewBadge: document.getElementById('previewBadge'),
    urlBadge: document.getElementById('urlBadge'),
    fullscreenBtn: document.getElementById('fullscreenBtn'),
    deviceBtn: document.getElementById('deviceBtn'),
    deviceMenu: document.getElementById('deviceMenu'),
    reloadBtn: document.getElementById('reloadBtn'),
    inspectBtn: document.getElementById('inspectBtn'),
    themeBtn: document.getElementById('themeBtn'),
    themeIconSun: document.getElementById('themeIconSun'),
    themeIconMoon: document.getElementById('themeIconMoon'),
    sendBtn: document.getElementById('sendBtn'),
    clearBtn: document.getElementById('clearBtn'),
    exportBtn: document.getElementById('exportBtn'),
    renderBtn: document.getElementById('renderBtn'),
    clearCodeBtn: document.getElementById('clearCodeBtn'),
    codeArea: document.getElementById('codeArea'),
    lineNumbers: document.getElementById('lineNumbers'),
    fileList: document.querySelector('.file-list'),
    editorTabs: document.querySelector('.editor-tabs'),
    urlInput: document.getElementById('urlInput'),
    goBtn: document.getElementById('goBtn'),
    addFileMenuBtn: document.getElementById('addFileMenuBtn'),
    addFileMenu: document.getElementById('addFileMenu'),
    fileContextMenu: document.getElementById('fileContextMenu'),
    addApiKeyForm: document.getElementById('addApiKeyForm'),
    apiNameInput: document.getElementById('apiNameInput'),
    apiKeyValueInput: document.getElementById('apiKeyValueInput'),
    apiList: document.getElementById('apiList'),
  };
  
  let activeFileItem = null;
  let isFrameAccessibleForInspect = true;

  const icons = {
      edit: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
      trash: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
      copy: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
      code: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>'
  };

  const fileIcons = {
    html: '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>',
    css: '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a7 7 0 1 0 10 10"></path></svg>',
    js: '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 6.1H7l-2 8h2l1-4h4l-1 4h2l2-8h-2l-1 4h-4l1-4z"/></svg>',
    default: '<svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'
  };
  
  const codeManager = (function() {
    const internalState = {
        files: {},
        openFiles: [],
        activeFile: null
    };
    let deps = {};

    function _getDefaultFiles() {
        return {
            'index.html': { content: '<h1>Hello, World!</h1>\n<p>Edit this content to get started.</p>', type: 'html' },
            'index.css': { content: 'body {\n  font-family: sans-serif;\n  padding: 1rem;\n}\nh1 {\n  color: dodgerblue;\n}', type: 'css' },
            'index.js': { content: 'console.log("Hello from JavaScript!");\ndocument.querySelector("h1").addEventListener("click", () => alert("You clicked the heading!"));', type: 'js' }
        };
    }

    function _save() {
        try {
            localStorage.setItem('codeState', JSON.stringify(internalState));
        } catch(e) { console.warn("Could not save code state:", e); }
    }

    function _load() {
        try {
            const stored = localStorage.getItem('codeState');
            if(stored) {
                const parsed = JSON.parse(stored);
                // Basic validation
                if (parsed.files && parsed.openFiles && typeof parsed.activeFile !== 'undefined') {
                    Object.assign(internalState, parsed);
                    return;
                }
            }
        } catch(e) { console.warn("Could not load code state:", e); }
        // If load fails or no data, set defaults
        internalState.files = _getDefaultFiles();
    }
    
    function _getIcon(path) {
        const type = internalState.files[path]?.type;
        return fileIcons[type] || fileIcons.default;
    }
    
    function _renderAll() {
        _renderFileExplorer();
        _renderTabs();
        _renderEditor();
    }

    function _renderFileExplorer() {
        deps.fileList.innerHTML = '';
        Object.keys(internalState.files).forEach(path => {
            const file = internalState.files[path];
            const item = document.createElement('div');
            item.className = 'file-item';
            item.dataset.path = path;
            if (path === internalState.activeFile) {
                item.classList.add('active');
            }
            item.innerHTML = `${_getIcon(path)}<span class="file-name">${path}</span>`;
            deps.fileList.appendChild(item);
        });
    }

    function _renderTabs() {
        deps.editorTabs.innerHTML = '';
        internalState.openFiles.forEach(path => {
            const tab = document.createElement('div');
            tab.className = 'editor-tab';
            tab.dataset.path = path;
            if (path === internalState.activeFile) {
                tab.classList.add('active');
            }
            tab.innerHTML = `${_getIcon(path)}
                             <span>${path}</span>
                             <button class="close-tab-btn" aria-label="Close tab">&times;</button>`;
            deps.editorTabs.appendChild(tab);
        });
    }
    
    function _renderEditor() {
        if(internalState.activeFile && internalState.files[internalState.activeFile]) {
            deps.codeArea.value = internalState.files[internalState.activeFile].content;
            deps.codeArea.disabled = false;
            deps.codeArea.placeholder = "Start typing your code here...";
        } else {
            deps.codeArea.value = '';
            deps.codeArea.disabled = true;
            deps.codeArea.placeholder = "Open a file from the explorer to begin editing.";
        }
        updateEditorLayout();
    }
    
    function openFile(path) {
        if (!internalState.files[path]) return;
        if (!internalState.openFiles.includes(path)) {
            internalState.openFiles.push(path);
        }
        setActiveFile(path);
    }

    function setActiveFile(path) {
        if (!internalState.files[path] || !internalState.openFiles.includes(path)) return;
        internalState.activeFile = path;
        _renderAll();
        _save();
    }

    function closeFile(path) {
        const index = internalState.openFiles.indexOf(path);
        if (index === -1) return;
        
        internalState.openFiles.splice(index, 1);

        if (internalState.activeFile === path) {
            internalState.activeFile = internalState.openFiles[internalState.openFiles.length - 1] || null;
        }
        _renderAll();
        _save();
    }
    
    function updateActiveFileContent(content) {
        if (internalState.activeFile && internalState.files[internalState.activeFile]) {
            internalState.files[internalState.activeFile].content = content;
            _save();
        }
    }

    function getCombinedHtml() {
        const html = internalState.files['index.html']?.content || '';
        const css = internalState.files['index.css']?.content || '';
        const js = internalState.files['index.js']?.content || '';

        if (!html.trim() && !css.trim() && !js.trim()) return '';

        // Use DOMParser to safely manipulate the HTML structure
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Ensure head and body elements exist
        if (!doc.head) doc.documentElement.insertBefore(doc.createElement('head'), doc.body);
        if (!doc.body) doc.documentElement.appendChild(doc.createElement('body'));

        if (css.trim()) {
            const style = doc.createElement('style');
            style.textContent = css;
            doc.head.appendChild(style);
        }

        if (js.trim()) {
            const script = doc.createElement('script');
            // Using textContent is safer than innerHTML
            script.textContent = js; 
            doc.body.appendChild(script);
        }

        return doc.documentElement.outerHTML;
    }
    
    function clearActiveFile() {
        if (internalState.activeFile) {
            internalState.files[internalState.activeFile].content = '';
            _renderEditor();
            _save();
        }
    }
    
    function init(dependencies) {
        deps = dependencies;
        _load();

        if (internalState.openFiles.length === 0) {
            openFile('index.html');
        } else {
             // Ensure active file is valid, otherwise reset
            if (!internalState.activeFile || !internalState.openFiles.includes(internalState.activeFile)) {
                internalState.activeFile = internalState.openFiles[0] || null;
            }
            _renderAll();
        }
        
        deps.fileList.addEventListener('click', e => {
            const fileItem = e.target.closest('.file-item');
            if (fileItem && fileItem.dataset.path) {
                openFile(fileItem.dataset.path);
            }
        });
        
        deps.editorTabs.addEventListener('click', e => {
            const tab = e.target.closest('.editor-tab');
            if (!tab) return;
            const path = tab.dataset.path;

            if (e.target.closest('.close-tab-btn')) {
                closeFile(path);
            } else {
                setActiveFile(path);
            }
        });

        deps.codeArea.addEventListener('input', () => {
             updateActiveFileContent(deps.codeArea.value);
        });
    }
    
    return { init, getCombinedHtml, clearActiveFile };
  })();

  const messageManager = (function() {
    const internalState = {
        messages: [],
    };

    let deps = {}; // To hold dependencies from the outer scope

    function _createActionsHTML(id) {
        return (
          `<div class="msg-actions">
            <button aria-label="Highlight to Code" title="Highlight to Code">${deps.icons.code}</button>
            <button aria-label="Copy message" title="Copy" onclick="messageManager.copy(${id})">${deps.icons.copy}</button>
            <button aria-label="Edit message" title="Edit" onclick="messageManager.edit(${id})">${deps.icons.edit}</button>
            <button aria-label="Delete message" title="Delete" onclick="messageManager.delete(${id})">${deps.icons.trash}</button>
          </div>`
        );
    }

    function _render(msgObj) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.dataset.id = msgObj.id;
        div.innerHTML = '<strong style="font-weight:600">You:</strong><pre>' + deps.escapeHtml(msgObj.content) + '</pre>' + _createActionsHTML(msgObj.id);
        deps.chatMessages.appendChild(div);
        deps.chatMessages.scrollTop = deps.chatMessages.scrollHeight;
    }
    
    function _findMessage(id) {
        const numericId = Number(id);
        return internalState.messages.find(m => m.id === numericId);
    }

    function _findIndex(id) {
        const numericId = Number(id);
        return internalState.messages.findIndex(m => m.id === numericId);
    }

    function add(content) {
        const val = content.trim();
        if (!val) return;
        const id = Date.now();
        const msgObj = { id, type: 'user', content: val };
        internalState.messages.push(msgObj);
        _render(msgObj);
        deps.chatInput.value = '';
        deps.addLog('✓ Message saved');
    }

    function copy(id) {
        const msgPreElement = document.querySelector(`.msg[data-id="${id}"] pre`);
        if (!msgPreElement) {
            deps.addLog('⚠️ Could not find message content to copy.');
            return;
        }
        navigator.clipboard.writeText(msgPreElement.textContent).then(() => {
            deps.addLog('✓ Message content copied');
        }).catch(err => {
            deps.addLog('⚠️ Failed to copy message');
        });
    }

    function edit(id) {
        const msgObj = _findMessage(id);
        if (!msgObj) return;
        const div = document.querySelector(`[data-id="${id}"]`);
        div.classList.add('editing');
        div.innerHTML = `<strong style="font-weight:600">Edit:</strong><textarea id="edit-${id}">${deps.escapeHtml(msgObj.content)}</textarea>
                        <div style="margin-top:8px;display:flex;gap:4px">
                            <button class="btn" onclick="messageManager.saveEdit(${id})">Save</button>
                            <button class="btn outline" onclick="messageManager.cancelEdit(${id})">Cancel</button>
                        </div>`;
        document.getElementById(`edit-${id}`).focus();
    }

    function saveEdit(id) {
        const newContent = document.getElementById(`edit-${id}`).value.trim();
        if (!newContent) return;
        const msgObj = _findMessage(id);
        if (!msgObj) return;
        msgObj.content = newContent;
        const div = document.querySelector(`[data-id="${id}"]`);
        div.classList.remove('editing');
        div.innerHTML = '<strong style="font-weight:600">You:</strong><pre>' + deps.escapeHtml(newContent) + '</pre>' + _createActionsHTML(id);
        deps.addLog('✓ Message edited');
    }

    function cancelEdit(id) {
        const msgObj = _findMessage(id);
        if (!msgObj) return;
        const div = document.querySelector(`[data-id="${id}"]`);
        div.classList.remove('editing');
        div.innerHTML = '<strong style="font-weight:600">You:</strong><pre>' + deps.escapeHtml(msgObj.content) + '</pre>' + _createActionsHTML(id);
    }
    
    function del(id) {
        if (!confirm('Delete this message?')) return;
        
        const index = _findIndex(id);
        if (index > -1) {
            internalState.messages.splice(index, 1);
        } else {
            deps.addLog('⚠️ Message not found in state, but attempting to remove from view.');
        }

        const messageElement = document.querySelector(`.msg[data-id="${id}"]`);
        if (messageElement) {
            messageElement.remove();
            deps.addLog('✓ Message deleted');
        } else {
            deps.addLog('⚠️ Message element not found in the DOM.');
        }
    }

    function clearAll() {
        if (internalState.messages.length === 0) {
            deps.addLog('⚠️ No messages to clear.');
            return;
        }
        if (confirm('Delete all messages?')) {
            internalState.messages.length = 0;
            deps.chatMessages.innerHTML = '';
            deps.addLog('✓ All messages deleted.');
        }
    }

    function exportChat() {
        if (internalState.messages.length === 0) return deps.addLog('⚠️ No messages to export');
        let text = '=== CHAT EXPORT ===\n\n';
        internalState.messages.forEach((m, i) => {
            text += `[${i + 1}] ${new Date(m.id).toLocaleString()}\n${m.content}\n\n`;
        });
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        deps.addLog('✓ Messages exported');
    }
    
    function init(dependencies) {
        deps = dependencies;
        deps.sendBtn.onclick = () => add(deps.chatInput.value);
        deps.chatInput.onkeydown = e => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) add(deps.chatInput.value);
        };
        deps.exportBtn.onclick = exportChat;
    }

    return { init, copy, edit, saveEdit, cancelEdit, delete: del, clearAll };
  })();
  window.messageManager = messageManager;

  const apiManager = (function() {
      const internalState = {
          apiKeys: []
      };
      let deps = {};

      function _save() {
          try {
              localStorage.setItem('apiKeys', JSON.stringify(internalState.apiKeys));
          } catch (e) {
              deps.addLog('⚠️ Could not save API keys to local storage.');
          }
      }

      function _load() {
          try {
              const storedKeys = localStorage.getItem('apiKeys');
              if (storedKeys) {
                  internalState.apiKeys = JSON.parse(storedKeys);
              }
          } catch (e) {
              deps.addLog('⚠️ Could not load API keys from local storage.');
              internalState.apiKeys = [];
          }
      }

      function _render() {
          deps.apiList.innerHTML = '';
          if (internalState.apiKeys.length === 0) {
              deps.apiList.innerHTML = '<div class="empty-state">No API keys saved yet.</div>';
              return;
          }

          internalState.apiKeys.forEach(apiKey => {
              const item = document.createElement('div');
              item.className = 'api-item';
              item.dataset.id = apiKey.id;
              
              const maskedKey = apiKey.value.substring(0, 4) + '...'.padEnd(apiKey.value.length - 8, '.') + apiKey.value.substring(apiKey.value.length - 4);
              
              item.innerHTML = `
                  <div class="api-item-info">
                      <span class="api-item-name">${deps.escapeHtml(apiKey.name)}</span>
                      <span class="api-item-key" data-visible="false" data-full-key="${deps.escapeHtml(apiKey.value)}">${maskedKey}</span>
                  </div>
                  <div class="api-item-actions">
                      <button class="btn outline" onclick="apiManager.toggleVisibility('${apiKey.id}')">Show</button>
                      <button class="btn outline" onclick="apiManager.delete('${apiKey.id}')" title="Delete Key">${deps.icons.trash}</button>
                  </div>
              `;
              deps.apiList.appendChild(item);
          });
      }

      function add(name, value) {
          const id = Date.now().toString();
          internalState.apiKeys.push({ id, name, value });
          _save();
          _render();
          deps.addLog(`✓ API Key for "${name}" saved.`);
      }

      function del(id) {
          const keyToDelete = internalState.apiKeys.find(k => k.id === id);
          if (keyToDelete && confirm(`Delete API key for "${keyToDelete.name}"?`)) {
              internalState.apiKeys = internalState.apiKeys.filter(key => key.id !== id);
              _save();
              _render();
              deps.addLog(`✓ API Key for "${keyToDelete.name}" deleted.`);
          }
      }
      
      function toggleVisibility(id) {
          const item = document.querySelector(`.api-item[data-id="${id}"]`);
          if (!item) return;
          const keySpan = item.querySelector('.api-item-key');
          const button = item.querySelector('.btn');
          const isVisible = keySpan.dataset.visible === 'true';

          if (isVisible) {
              const fullKey = keySpan.dataset.fullKey;
              const maskedKey = fullKey.substring(0, 4) + '...'.padEnd(fullKey.length - 8, '.') + fullKey.substring(fullKey.length - 4);
              keySpan.textContent = maskedKey;
              button.textContent = 'Show';
              keySpan.dataset.visible = 'false';
          } else {
              keySpan.textContent = keySpan.dataset.fullKey;
              button.textContent = 'Hide';
              keySpan.dataset.visible = 'true';
          }
      }
      
      function init(dependencies) {
          deps = dependencies;
          _load();
          _render();
          
          deps.addApiKeyForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const name = deps.apiNameInput.value.trim();
              const value = deps.apiKeyValueInput.value.trim();
              if (name && value) {
                  add(name, value);
                  deps.apiNameInput.value = '';
                  deps.apiKeyValueInput.value = '';
              } else {
                  deps.addLog('⚠️ Please provide both a name and a value for the API key.');
              }
          });
      }

      return { init, delete: del, toggleVisibility };
  })();
  window.apiManager = apiManager;


  function setActiveView(view) {
    if (view === 'url') {
      state.frame = el.urlFrame;
      state.overlay = el.urlOverlay;
      state.badge = el.urlBadge;
    } else {
      state.frame = el.previewFrame;
      state.overlay = el.previewOverlay;
      state.badge = el.previewBadge;
    }
  }

  el.tabs.forEach(tab => {
    tab.onclick = () => {
      const view = tab.dataset.view;
      el.tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      el.views.forEach(v => v.classList.remove('active'));
      document.getElementById(view + 'View').classList.add('active');
      state.view = view;
      if (view !== 'log' && view !== 'api') setActiveView(view);
      if (state.inspect && view !== 'preview' && view !== 'url') {
        toggleInspect();
      }
    };
  });
  
  function setDevice(device) {
      if (!device) return;
      state.device = device;
      
      const dimensions = {
          desktop: { width: '100%', height: '100%', borderRadius: '0', border: 'none' },
          tablet: { width: '768px', height: '1024px', borderRadius: '12px', border: '1px solid var(--border)' },
          mobile: { width: '375px', height: '812px', borderRadius: '12px', border: '1px solid var(--border)' }
      };
      
      const { width, height, borderRadius, border } = dimensions[device];
      
      [el.previewFrame, el.urlFrame].forEach(frame => {
          frame.style.width = width;
          frame.style.height = height;
          frame.style.borderRadius = borderRadius;
          frame.style.border = border;
      });
      
      document.querySelectorAll('.preview-wrap').forEach(wrap => {
          wrap.classList.toggle('device-mode', device !== 'desktop');
      });
      
      el.deviceMenu.querySelectorAll('.dropdown-item').forEach(item => {
          item.classList.toggle('active', item.dataset.device === device);
      });
      
      el.deviceBtn.classList.toggle('active', device !== 'desktop');
      
      addLog(`✓ Switched to ${device} view`);
      el.deviceMenu.classList.remove('active');
  }

  el.deviceBtn.onclick = (e) => {
      e.stopPropagation();
      el.deviceMenu.classList.toggle('active');
  };

  el.deviceMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.dropdown-item');
      if (item && item.dataset.device) {
          setDevice(item.dataset.device);
      }
  });

  function setTheme(theme) {
      document.body.dataset.theme = theme;
      if (theme === 'dark') {
          el.themeIconSun.style.display = 'none';
          el.themeIconMoon.style.display = 'block';
      } else {
          el.themeIconSun.style.display = 'block';
          el.themeIconMoon.style.display = 'none';
      }
  }

  el.themeBtn.onclick = () => {
    const newTheme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
  };

  el.renderBtn.onclick = () => {
    const code = codeManager.getCombinedHtml();
    if (!code) return addLog('⚠️ No code to render');
    el.previewFrame.srcdoc = code;
    document.querySelector('.tab[data-view="preview"]').click();
    resetFrameAccessState();
    addLog('✓ Rendered successfully');
  };

  el.clearCodeBtn.onclick = () => {
    if (confirm('Clear code in active file?')) {
        codeManager.clearActiveFile();
    }
  };
  
  function updateEditorLayout() {
    if (!el.codeArea || !el.lineNumbers) return;

    const lines = el.codeArea.value.split('\n');
    const lineCount = lines.length || 1;
    const numbers = Array.from({ length: lineCount }, (_, i) => i + 1).join('\n');
    el.lineNumbers.textContent = numbers;

    el.codeArea.style.height = 'auto';
    const editorWrapper = el.codeArea.parentElement;
    const minHeight = editorWrapper ? editorWrapper.clientHeight : 0;
    const scrollHeight = el.codeArea.scrollHeight;
    
    el.codeArea.style.height = `${Math.max(scrollHeight, minHeight)}px`;
  }

  el.codeArea.addEventListener('input', updateEditorLayout);
  new ResizeObserver(updateEditorLayout).observe(el.codeArea.parentElement);

  function showFrameAccessError() {
      if (!state.badge || !state.overlay || !state.frame) return;

      const message = state.inspect ? 'INSPECTION BLOCKED' : 'CONTENT BLOCKED';
      state.badge.textContent = message;
      state.badge.classList.add('active');
      state.badge.style.backgroundColor = '#ef4444'; // Red for error
      state.overlay.style.cursor = 'not-allowed';

      if (state.inspect) {
          isFrameAccessibleForInspect = false;
      }
      
      if (!state.frame.dataset.accessError) {
        addLog(`⚠️ Cannot access content. The site may have security policies (like X-Frame-Options or CSP) that prevent it from being embedded or inspected.`);
        state.frame.dataset.accessError = "true";
      }
  }

  function resetFrameAccessState() {
      if (!state.badge || !state.overlay || !state.frame) return;
      
      state.frame.dataset.accessError = "";
      state.badge.style.backgroundColor = ''; // Reset color
      state.overlay.style.cursor = state.inspect ? 'crosshair' : '';
      
      if (state.inspect) {
          state.badge.textContent = 'INSPECTING';
          state.badge.classList.add('active');
          isFrameAccessibleForInspect = true;
      } else {
          state.badge.classList.remove('active');
      }
  }

  el.goBtn.onclick = () => {
    let url = el.urlInput.value.trim();
    if (!url) return addLog('⚠️ Enter a URL');
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }
    try {
      new URL(url);
    } catch (e) {
      return addLog('⚠️ Invalid URL format');
    }

    resetFrameAccessState();

    try {
      el.urlFrame.src = url;
      addLog('→ Loading: ' + url);
      
      el.urlFrame.onload = () => {
          addLog('✓ URL loaded');
          try {
            const doc = el.urlFrame.contentDocument || el.urlFrame.contentWindow.document;
            // This check will throw a cross-origin error if content is inaccessible
            if (doc.body) {
               resetFrameAccessState();
            } else {
               // This case is unlikely, but good to have a fallback
               throw new Error("Inaccessible or empty content");
            }
          } catch (e) {
            showFrameAccessError();
          }
      };
      
      el.urlFrame.onerror = () => {
        // This can catch network errors before the iframe even tries to render
        showFrameAccessError();
      };
      
    } catch (e) {
      addLog('⚠️ Error setting URL source');
    }
  };
  
  el.urlInput.onkeydown = e => {
    if (e.key === 'Enter') el.goBtn.click();
  }

  function reloadActiveFrame() {
    addLog(`↻ Reloading ${state.view} view...`);
    if (state.view === 'preview' || state.view === 'code') {
      const code = codeManager.getCombinedHtml();
      el.previewFrame.srcdoc = code;
      addLog('✓ Preview reloaded.');
    } else if (state.view === 'url') {
      const currentSrc = el.urlFrame.src;
      if (currentSrc && currentSrc !== 'about:blank') {
        el.urlFrame.src = el.urlFrame.src;
        addLog('✓ URL reloaded.');
      } else {
        addLog('⚠️ No URL to reload.');
      }
    } else {
      addLog(`⚠️ Reload is not applicable for the "${state.view}" view.`);
    }
  }
  
  function toggleFullScreen() {
    if (!document.fullscreenElement) {
      let elementToFullscreen;
      if (state.view === 'preview') {
        elementToFullscreen = el.previewFrame.parentElement;
      } else if (state.view === 'url') {
        elementToFullscreen = el.urlFrame.parentElement;
      } else {
        addLog(`⚠️ Fullscreen is not applicable for the "${state.view}" view.`);
        return;
      }

      if (elementToFullscreen && elementToFullscreen.requestFullscreen) {
        elementToFullscreen.requestFullscreen().catch(err => {
          addLog(`⚠️ Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
        });
        addLog('⤢ Entered fullscreen mode.');
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
        addLog('↘ Exited fullscreen mode.');
      }
    }
  }

  el.inspectBtn.onclick = toggleInspect;

  document.addEventListener('keydown', (e) => {
    if (e.shiftKey && (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') {
      e.preventDefault();
      toggleInspect();
    }
  });

  function toggleInspect() {
    state.inspect = !state.inspect;
    if (state.inspect) {
      isFrameAccessibleForInspect = true;
      el.inspectBtn.classList.add('active');
      el.inspectBtn.title = 'Cancel Inspect (Ctrl+Shift+C)';
      state.overlay.classList.add('active');
      state.badge.classList.add('active');
      if (state.badge) state.badge.textContent = 'INSPECTING';
      if (state.overlay) state.overlay.style.cursor = 'crosshair';
      enableInspect();
    } else {
      el.inspectBtn.classList.remove('active');
      el.inspectBtn.title = 'Inspect (Ctrl+Shift+C)';
      state.overlay.classList.remove('active');
      state.badge.classList.remove('active');
      if (state.overlay) state.overlay.style.cursor = '';
      disableInspect();
    }
  }

  let hovered = null;

  function enableInspect() {
    state.overlay.onmousemove = handleMove;
    state.overlay.onclick = handleClick;
  }

  function disableInspect() {
    state.overlay.onmousemove = null;
    state.overlay.onclick = null;
    clearHighlight();
  }

  function handleMove(e) {
    if (!isFrameAccessibleForInspect) return;
    try {
      const doc = state.frame.contentDocument || state.frame.contentWindow.document;
      const rect = state.frame.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const elem = doc.elementFromPoint(x, y);
      if (elem && elem !== hovered) {
        if (hovered) hovered.style.outline = '';
        elem.style.outline = '2px solid ' + getComputedStyle(document.body).getPropertyValue('--accent');
        hovered = elem;
      }
    } catch (e) {
      // Fallback in case the error wasn't caught on load
      showFrameAccessError();
    }
  }

  function handleClick(e) {
    if (!isFrameAccessibleForInspect) return;
    try {
      const doc = state.frame.contentDocument || state.frame.contentWindow.document;
      const rect = state.frame.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const elem = doc.elementFromPoint(x, y);
      if (elem) {
        clearHighlight();
        elem.style.outline = '2px solid ' + getComputedStyle(document.body).getPropertyValue('--accent');
        elem.style.outlineOffset = '2px';
        const info = extractInfo(elem);
        copyToChat(info);
      }
    } catch (e) {
      addLog('⚠️ Cannot select element');
    }
  }

  function clearHighlight() {
    try {
      const doc = state.frame.contentDocument || state.frame.contentWindow.document;
      const all = doc.querySelectorAll('*');
      all.forEach(elem => elem.style.outline = '');
    } catch (e) {}
  }

  function rgbToHex(rgb) {
    if (!rgb || !rgb.startsWith('rgb')) return rgb;
    const match = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
    if (!match) return rgb;
    const r = parseInt(match[1], 10);
    const g = parseInt(match[2], 10);
    const b = parseInt(match[3], 10);
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
  }

  function extractInfo(elem) {
    const computed = getComputedStyle(elem);
    const rect = elem.getBoundingClientRect();
    const tag = elem.tagName.toLowerCase();
    const idx = elem.id ? ' id="' + elem.id + '"' : '';
    const cls = elem.className ? ' class="' + elem.className + '"' : '';
    const txt = elem.textContent.trim().substring(0, 60);
    const html = elem.outerHTML.substring(0, 300);
    
    let attrs = [];
    for (const attr of elem.attributes) {
      if (attr.name !== 'style') {
        attrs.push(attr.value === '' ? attr.name : `${attr.name}="${attr.value}"`);
      }
    }
    const attributes = attrs.join(' ');

    const visual = {
      background: {
        raw: computed.backgroundColor,
        hex: rgbToHex(computed.backgroundColor)
      },
      color: {
        raw: computed.color,
        hex: rgbToHex(computed.color)
      },
      outline: {
        raw: computed.outlineColor,
        hex: rgbToHex(computed.outlineColor)
      },
      outlineSize: computed.outlineWidth,
      size: `${Math.round(rect.width)} × ${Math.round(rect.height)} px`
    };

    const directText = Array.from(elem.childNodes)
      .filter(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim())
      .map(n => n.textContent.trim())
      .join(' ');
      
    const children = Array.from(elem.children).map(child => {
      let desc = '';
      const childTag = child.tagName.toLowerCase();
      if (childTag === 'svg') desc = '(icon)';
      else if (childTag === 'img') desc = '(image)';
      return `<${childTag}> ${desc}`.trim();
    });

    const content = {
      text: directText || '(none)',
      children: children.length > 0 ? children : ['(none)']
    };
    
    const isFocusable = () => {
      return elem.tabIndex >= 0 && !elem.disabled ? 'yes' : 'no';
    };

    const accessibility = {
      role: elem.getAttribute('role') || tag,
      label: elem.getAttribute('aria-label') || elem.title,
      focusable: isFocusable()
    };
    
    const tempOutline = elem.style.outline;
    const tempOutlineOffset = elem.style.outlineOffset;
    elem.style.outline = '';
    elem.style.outlineOffset = '';
    const inlineStyle = elem.style.cssText;
    elem.style.outline = tempOutline;
    elem.style.outlineOffset = tempOutlineOffset;
    
    return { tag, attributes, idx, cls, txt, html, visual, content, accessibility, inlineStyle };
  }

  function copyToChat(info) {
    function formatInlineStyle(styleText) {
      if (!styleText) return '(none)';
      return styleText.split(';')
        .filter(s => s.trim())
        .map(s => `- ${s.trim()}`)
        .join('\n');
    }

    const text = `📍 Selected Element:
<${info.tag} ${info.attributes}> 

${info.idx}
${info.cls}
${info.txt}
${info.html}

Visual
- Background: ${info.visual.background.raw} / ${info.visual.background.hex}
- Text Color: ${info.visual.color.raw} / ${info.visual.color.hex}
- Outline: ${info.visual.outline.raw} / ${info.visual.outline.hex}
- Outline-size: ${info.visual.outlineSize}
- Size: ${info.visual.size}

Content
- Text: ${info.content.text}
- Children:
${info.content.children.map(c => `  - ${c}`).join('\n')}

Accessibility
- Role: ${info.accessibility.role}
- Label: "${info.accessibility.label || '(none)'}"
- Keyboard Focusable: ${info.accessibility.focusable}

Inline Style
${formatInlineStyle(info.inlineStyle)}

[REQUEST]
->`;
    el.chatInput.value = text;
    el.chatInput.focus();
    addLog('✓ Element info copied to chat');
  }

  el.clearBtn.onclick = () => {
    messageManager.clearAll();
  };

  function addLog(text) {
    const id = Date.now();
    const time = new Date().toLocaleTimeString();
    const logObj = { id, content: text, time };
    state.logs.push(logObj);
    const div = document.createElement('div');
    div.className = 'msg';
    div.style.padding = "8px 12px";
    div.style.fontSize = "13px";
    div.innerHTML = '<strong style="font-weight:500; color: var(--text-secondary)">[' + time + ']</strong><p style="margin-top:2px">' + text + '</p>';
    el.logMessages.insertBefore(div, el.logMessages.firstChild);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  
  function showFileContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();

    const fileItem = e.currentTarget.closest('.file-item');
    if (!fileItem) return;

    closeAddFileMenu();
    
    if (activeFileItem) {
        activeFileItem.classList.remove('context-menu-open');
    }
    
    activeFileItem = fileItem;
    activeFileItem.classList.add('context-menu-open');

    const menu = el.fileContextMenu;
    menu.classList.add('active');

    const menuWidth = menu.offsetWidth;
    const menuHeight = menu.offsetHeight;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;

    let top = e.clientY + 4;
    let left = e.clientX + 4;

    if (left + menuWidth > windowWidth) {
        left = windowWidth - menuWidth - 8;
    }
    if (top + menuHeight > windowHeight) {
        top = e.clientY - menuHeight - 4;
    }

    menu.style.top = `${top}px`;
    menu.style.left = `${left}px`;
  }

  function hideFileContextMenu() {
    if (activeFileItem) {
        activeFileItem.classList.remove('context-menu-open');
        activeFileItem = null;
    }
    if(el.fileContextMenu) el.fileContextMenu.classList.remove('active');
  }

  function init() {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
    setActiveView('preview');
    setDevice('desktop');

    codeManager.init({
        fileList: el.fileList,
        editorTabs: el.editorTabs,
        codeArea: el.codeArea,
        lineNumbers: el.lineNumbers,
    });

    messageManager.init({
        chatMessages: el.chatMessages,
        chatInput: el.chatInput,
        sendBtn: el.sendBtn,
        exportBtn: el.exportBtn,
        addLog: addLog,
        escapeHtml: escapeHtml,
        icons: icons
    });
    
    apiManager.init({
        apiList: el.apiList,
        addApiKeyForm: el.addApiKeyForm,
        apiNameInput: el.apiNameInput,
        apiKeyValueInput: el.apiKeyValueInput,
        addLog: addLog,
        escapeHtml: escapeHtml,
        icons: icons
    });

    document.querySelectorAll('.file-item-actions .control-btn').forEach(btn => {
        btn.addEventListener('click', showFileContextMenu);
    });

    el.fileContextMenu.addEventListener('click', (e) => {
        const item = e.target.closest('.dropdown-item');
        if (!item) return;

        const action = item.dataset.action;
        if (!action || !activeFileItem) return;

        const fileName = activeFileItem.querySelector('.file-name')?.textContent || 'file';
        let logMessage = '';

        switch (action) {
            case 'editor':
                logMessage = `Action: Show "${fileName}" in editor`;
                break;
            case 'rename':
                logMessage = `Action: Rename "${fileName}"`;
                break;
            case 'move':
                logMessage = `Action: Move "${fileName}"`;
                break;
            case 'delete':
                logMessage = `Action: Delete "${fileName}"`;
                break;
        }

        addLog(logMessage);
        hideFileContextMenu();
    });
    
    el.fullscreenBtn.onclick = toggleFullScreen;
    el.reloadBtn.onclick = reloadActiveFrame;

    addLog('✓ Application started');
  }

  function closeAddFileMenu() {
    el.addFileMenu.classList.remove('active');
  }

  window.appUploadFiles = function() {
      addLog('Action: Upload files clicked');
      closeAddFileMenu();
  }
  window.appUploadFolder = function() {
      addLog('Action: Upload folder clicked');
      closeAddFileMenu();
  }
  window.appCreateFile = function() {
      addLog('Action: Create new file clicked');
      closeAddFileMenu();
  }
  window.appCreateFolder = function() {
      addLog('Action: Create new folder clicked');
      closeAddFileMenu();
  }
  
  el.addFileMenuBtn.onclick = (e) => {
    e.stopPropagation();
    el.addFileMenu.classList.toggle('active');
  };

  document.addEventListener('click', (e) => {
    const target = e.target;
    if (el.addFileMenu.classList.contains('active') && !el.addFileMenu.contains(target) && !el.addFileMenuBtn.contains(target)) {
        el.addFileMenu.classList.remove('active');
    }
    if (el.deviceMenu.classList.contains('active') && !el.deviceMenu.contains(target) && !el.deviceBtn.contains(target)) {
        el.deviceMenu.classList.remove('active');
    }
    if (el.fileContextMenu.classList.contains('active') && !el.fileContextMenu.contains(target) && !target.closest('.file-item-actions')) {
        hideFileContextMenu();
    }
  });
  
  init();

})();
</script>

</body>
</html>
